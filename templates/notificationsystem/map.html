<!DOCTYPE html>
<!--<link type="text/css" rel="stylesheet" href="/css/realtimebox.css" />-->

<html>
<head>

<style type="text/css">
  body, html { width: 100%; height: 100%; margin: 0; padding: 0; }
</style>

<script type="text/javascript" src="/_ah/channel/jsapi"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="https://www.google.com/jsapi?key=ABQIAAAAWajWEMOvdMUzDSviTnY9_BQCULP4XOMyhPd8d_NrQQEO8sT8XBSloh91HGZYV6pQ4yQ1gkhp8E4bJw"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
<script type="text/javascript" src="/js/date.format.js"></script>
<script type="text/javascript" src="/js/markerclusterer.js"></script>

<script type="text/javascript">

    function formatDate(dateStr)
    {
        date = new Date(dateStr);
        return date.format("dd/mm/yyyy HH:MM:ss");
    }

    var map
    var mapCluster
    var eventLvl1 = "/images/alert1.png"
    var eventLvl2 = "/images/alert2.png"
    var eventLvl3 = "/images/alert3.png"
    var newevent  = "/images/newevent.gif"
    var newEventTime = 2000

    function initializeMap()
    {
        var latlng = new google.maps.LatLng(0, 0);
        var myOptions = {
            zoom: 2,
            center: latlng,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

        var mcOptions = {gridSize: 50, maxZoom: 14};
        mapCluster = new MarkerClusterer(map, [], mcOptions);
    }


    function placeNewEvent(type, event, latitude, longitude)
    {
        var icon;

        /* get the correct icon */
        switch(type)
        {
            case "Offline":
                icon = eventLvl1
                break
            case "Throttling":
                icon = eventLvl2
                break
            case "Censor":
                icon = eventLvl3
                break
            default:
                icon = eventLvl3
        }

        var marker = new google.maps.Marker({
            position: new google.maps.LatLng(latitude, longitude),
            title:"Shutdown!",
            icon: icon
        });

        /* set icon animation */
        marker.setAnimation(google.maps.Animation.BOUNCE)

        /* cancel icon animation after newEventTime */
        setInterval(function(){ marker.setAnimation(); }, newEventTime);

        /* create info window */
        var infowindow = new google.maps.InfoWindow({
            content: event
        });

        /* configure click to show info window */
        google.maps.event.addListener(marker, 'click', function() {
            infowindow.open(map, marker);
        });

        mapCluster.addMarker(marker);

        /* put marker on map */
        //marker.setMap(map);
    }

    function addEventToMap(event, appear)
    {
        baseInfo = "<a href='" + event.url + "'>" + event.targetType + " " + event.type + " " + event.target + "</a><br />First Detection: " + formatDate(event.firstdetection) + "<br />Last Detection: " + formatDate(event.lastdetection) + "<br />Location: ";

        for(i=0; i<event.locations.length; i++)
        {
            localInfo = "";
            if(event.locations[i].city!="")
                localInfo = event.locations[i].city + ", ";
            localInfo += event.locations[i].country;

            eventInfo = baseInfo + localInfo;

            placeNewEvent(event.type, eventInfo, event.locations[i].lat, event.locations[i].lng)
        }
        // TODO: format information; show all information
    }

    onOpened = function() {
        $("#map_status").html("Waiting for events...")
    };

    onMessage = function(m) {
        event = JSON.parse(m.data)
        //$("#map_status").html("New event")
        addEventToMap(event, true)
    }

    onError = function() {
        alert("error")
        $("#map_status").html("Error loading events")
    }

    openChannel = function() {
        var token = '{{ token }}';
        var channel = new goog.appengine.Channel(token);
        var handler = {
          'onopen': onOpened,
          'onmessage': onMessage,
          'onerror': onError,
          'onclose': function() {}
        };
        var socket = channel.open(handler);
        socket.onopen = onOpened;
        socket.onmessage = onMessage;
        socket.onerror = onError;
    }

    updateInitialEvents = function(m)
    {
        events = JSON.parse(m.data)
        for(var i=0; i<events.length; i++)
        {
            addEventToMap(events[i], false)
        }
    }

    initialize = function() {
        initializeMap();
        openChannel();
        updateInitialEvents({data: '{{ initial_events|safe }}'});
    }

    //setTimeout(initialize, 100);


</script>

</head>
<body onload="initialize()">

<div id="map_status">
    
</div>
<div id="map_canvas" style="width:100%; height:100%;"></div>

</body>
</html>